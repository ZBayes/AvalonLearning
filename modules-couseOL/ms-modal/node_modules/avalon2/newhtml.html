<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Title</title>
        <link href="1.css" rel="stylesheet" type="text/css">

        <script src="//cdn.bootcss.com/avalon.js/1.5.8/avalon.js"></script>
        <style>

        </style>
        <script>
            
            var json = {
                "bizData": {
                    "resultMsg": "查询成功",
                    "result": 1,
                    "data": [
                        {
                            "catMode": "0013",
                            "childDepts": [],
                            "createDate": 0,
                            "customName": "维修部",
                            "deptCode": "gxgj-wxb",
                            "deptSchoolMemberId": 0,
                            "id": 14,
                            "isolated": 0,
                            "lastModDate": 1476695594724,
                            "lastModDateAsDate": "2016-10-17 17:13:14",
                            "parentId": 0,
                            "schoolCode": "6101024000",
                            "status": 0,
                            "teachers": [
                                {
                                    "name": "张娇",
                                    "status": "1",
                                    "uid": "5d65a6f0try83681bfc54e4f843"
                                },
                                {
                                    "name": "张飞",
                                    "status": "1",
                                    "uid": "c5389711135111e6bb57fa163e33daaa"
                                },
                                {
                                    "headImage": "http://qkyb.ks3-cn-center-1.ksyun.com/20160506155213.xC5B8ny8Lo.jpg",
                                    "name": "陈启泰",
                                    "status": "1",
                                    "uid": "09e8d6d8eret7fa163e33uytaaa"
                                },
                                {
                                    "name": "樱木花道",
                                    "status": "0",
                                    "uid": "3fa116a3fertretbed7fa163e33daaa"
                                },
                                {
                                    "name": "弦治",
                                    "status": "0",
                                    "uid": "3fada83bf1sdfdsfe5bed7fa163e33daaa"
                                },
                                {
                                    "headImage": "http://qkyb.ks3-cn-center-1.ksyun.com/20160817095023.aRaoJgILW0.jpg",
                                    "name": "陈新元",
                                    "status": "0",
                                    "uid": "14f904d0714d455434533daaa"
                                }
                            ],
                            "weixinId": 0
                        },
                        {
                            "catMode": "001400020001",
                            "childDepts": [],
                            "createDate": 0,
                            "customName": "美术组1",
                            "deptCode": "GXGJ-美术301",
                            "deptSchoolMemberId": 0,
                            "id": 73,
                            "isolated": 0,
                            "lastModDate": 1476695594724,
                            "lastModDateAsDate": "2016-10-17 17:13:14",
                            "parentId": 0,
                            "schoolCode": "6101024000",
                            "status": 0,
                            "teachers": [
                                {
                                    "name": "张老师",
                                    "status": "0",
                                    "uid": "c741dc6b13rtyrtfa163e33daaa"
                                },
                                {
                                    "name": "梁老师",
                                    "status": "0",
                                    "uid": "c5739ghjhg5111e6bb57fa163e33daaa"
                                }
                            ],
                            "weixinId": 0
                        }
                    ]
                },
                "rtnCode": "0000000",
                "ts": 1476695594347
            }

            var vm = avalon.define({
                $id: 'vm',
                //这里放教师的分组,每个分组都有教师数组,里面是教师的名字,状态与uid
                teachersGrounp: [],
                //使用$name不可监控对象来保存所有人的名字
                $names: {},
                //这里只放教师的名字,一维数组
                selected: [],
                //根据uid显示名字
                showName: function (uid) {
                    return vm.$names[uid]
                },
                 //根据ID将人员放回原位置上,并从selected数组移除
                restore: function(uid){
                  
                    var gid, data
                    try{
                        json.bizData.data.forEach(function (el) {
                            gid = el.id
                            el.teachers.forEach(function (teacher) {
                                if(teacher.uid === uid){
                                    data = avalon.mix(true, {}, teacher)
                                    throw 'error'
                                }
                            })
                        })
                    }catch(e){
                        
                    }
                    vm.teachersGrounp.forEach(function(el){
                        if(el.id === gid){
                            el.teachers.push(data)
                        }
                    })
                    vm.selected.remove(uid)
                },
                //将数据显示出来,注意,所有数组必须深复制,防止影响数据源,并在这里构建$name
                show: function () {

                    setTimeout(function () {

                        json.bizData.data.forEach(function (el) {
                            el.teachers.forEach(function (elem) {
                                vm.$names[elem.uid] = elem.name
                            })
                        })
                        vm.teachersGrounp.pushArray(avalon.mix(true, [], json.bizData.data))
                    })
                }
            });
            vm.$watch('selected.length', function () {
                //如果selected的长度发生变化,遍历分组
                vm.teachersGrounp.forEach(function (el) {
                    el.teachers.removeAll(function (teacher) {
                        //如果uid位于selected数组之中
                        return vm.selected.indexOf(teacher.uid) > -1
                    })
                })
            })
            vm.show();


        </script>
    </head>
    <body ms-controller="vm" id="updatepx">
        <h1>选择了:<span class="selectON" ms-repeat="selected" ms-click="restore(el)">
                {{showName(el)}}
            </span>
        </h1>
        <div ms-repeat="teachersGrounp">
            <button ms-text="el.customName" class="px_groupname">

            </button>
            <div class="px_namebox" ms-repeat-teacher="el.teachers">
                <input type="checkbox" class="qkychbox fang trn" ms-duplex='selected' ms-attr-value='teacher.uid'>
                <span class="bbb" ms-text="teacher.name"></span>
                <span class="ccc option0" ms-text="teacher.status"></span>
            </div>
        </div>
    </body>
</html>
